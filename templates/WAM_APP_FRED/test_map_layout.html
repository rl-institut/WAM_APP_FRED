<!DOCTYPE html>
{% load leaflet_tags %}
{% load static %}


<html class="no-js" lang="en">

<head>


  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>open_FRED</title>
  <link rel="shortcut icon" type="image/png" href="{% static '/WAM_APP_FRED/img/fav/favicon.ico' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'stemp_abw/img/ionicons-2.0.1/css/ionicons.css' %}">
  <link rel="stylesheet" href="{% static 'WAM_APP_FRED/foundation/css/app.css' %}">
  <link rel="stylesheet" href="{% static 'WAM_APP_FRED/clusters/css/MarkerCluster.css' %}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
  {% leaflet_js %}
  {% leaflet_css %}
  <script src="{% static 'WAM_APP_FRED/clusters/js/leaflet.markercluster-src.js' %}"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>

  <div class="l-bg-color-w u-vh--100">

    <!-- TOP NAVIGATION START -->
    <!-- MAIN NAVIGATION START -->

    <nav>
      <div class="title-bar" id="nav-container" data-responsive-toggle="simple-menu" data-hide-for="medium">
        <button class="menu-icon" type="button" data-toggle></button>
        <div class="title-bar-title"></div>
      </div>

      <div class="top-bar" id="simple-menu">
        <div class="top-bar-left show-for-large">
          <ul class="menu">

          </ul>
        </div>
        <div class="top-bar-right">
          <ul class="dropdown menu" id="nav-list-vertical" data-dropdown-menu>
            <li>
              <a class="anchor-text--light" href="#">Menu</a>
              <ul class="menu vertical">

                <li><a class="anchor-text--light" href="#">Kontakt</a></li>
                <li><a class="anchor-text--light" href="#">Impressum</a></li>
                <li><a class="anchor-text--light" href="#">Datenschutz</a></li>
                <li><a class="anchor-text--light" href="#">Quellen</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- MAIN NAVIGATION END -->
    <!-- TOP NAVIGATION END -->

    <div class="off-canvas-wrapper off-canvas-wrapper--left">

      <!-- OFF CANVAS START -->
      <div class="off-canvas position-left" id="offCanvas" data-off-canvas data-close-on-click="false" data-content-overlay="false" data-transition="overlap" style="color: black; overflow-y: hidden">

        <div class="grid-y medium-grid-frame">
          <div class="cell medium-auto medium-cell-block-container">
            <div class="grid-x">
              <div class="cell small-3 offcanvas-tabs__wrapper medium-cell-block-y">
                <ul class="vertical tabs" data-tabs id="offcanvas-tabs">
                  <li class="tabs-title is-active">
                    <a href="#panel-energy-system">
                      <img src="{% static 'WAM_APP_FRED/img/tab_icons/weather.svg' %}">
                      <h2 class="tabs-title__head">Weather Data</h2>
                    </a>
                  </li>
                  <li class="tabs-title">
                    <a href="#panel-powerplants">
                      <img src="{% static 'WAM_APP_FRED/img/tab_icons/powerplants.svg' %}">
                      <h2 class="tabs-title__head">Power Plant Register</h2>
                    </a>
                  </li>
                  <li class="tabs-title">
                    <a href="#panel-feedinlib">
                      <img src="{% static 'WAM_APP_FRED/img/tab_icons/feedin.svg' %}">
                      <h2 class="tabs-title__head">Feedin-Time Series</h2>
                    </a>
                  </li>
                </ul>

              </div>
              <div class="cell small-9 medium-cell-block-y tabs-content__wrapper">
                <div class="tabs-content" data-tabs-content="offcanvas-tabs" id="fred-tabs">

                  <!-- First panel content -->
                  <div class="tabs-panel" id="panel-powerplants">
                    <h4>Power Plant Register</h4>
                    <p>Select a type of powerplant in this menu. When you click on the map, it will load all powerplants of that type within the selected state. Loading may take a while. Click on another state to load new data.</p>
                    <form>
                      <fieldset>
                        <legend>Szenario auswählen
                          <i class="icon ion-information-circled icon--small" title="Informationen zum Inhalt"></i>
                        </legend>
                        <div>
                          <input type="radio" name="generation_type" value="solar" id="Solar" required checked>
                          <label for="Solar">Photovoltaikanlagen</label>
                        </div>
                        <div>
                          <input type="radio" name="generation_type" value="wind" id="Wind">
                          <label for="Wind">Windkraftanlagen</label>
                        </div>
                        <div>
                          <input type="radio" name="generation_type" value="geothermal" id="Geothermal">
                          <label for="Geothermal">Geothermieanlagen</label>
                        </div>
                        <div>
                          <input type="radio" name="generation_type" value="run_of_river" id="Run_of_river">
                          <label for="Run_of_river">Wasserkraftanlage</label>
                        </div>
                        <div>
                          <input type="radio" name="generation_type" value="gas" id="Gas">
                          <label for="Gas">Gaskraftwerk</label>
                        </div>
                        <div>
                          <input type="radio" name="generation_type" value="reservoir" id="Reservoir">
                          <label for="Reservoir">Pumpspeicherkraftwerk</label>
                        </div>
                        <div>
                          <input type="radio" name="generation_type" value="biomass" id="Biomass">
                          <label for="Biomass">Biogasanlage</label>
                        </div>
                      </fieldset>
                    </form>
                  </div>

                  <!-- Second panel content -->
                  <div class="tabs-panel is-active" id="panel-energy-system">
                    <h4>Weather Data</h4>
                    <p>Click on the map to load the closest weather data points. You can then click on one of the loaded points to to display the weather data over the selected time period for a given height and variable. The download can take some
                      time, depending on how many data you required. </p>

                    <ul class="accordion" data-accordion>
                      <li class="accordion-item accordion-item--no-border is-active" data-accordion-item>

                        <a href="#" class="accordion-title accordion-title--100">Time Span</a>
                        <div class="accordion-content" data-tab-content>
                          <div class="tabs-panel is-active" id="options-energy-system">

                            <form id="wd_timespan">

                              <div>Start date
                                {{start_date}}
                              </div>
                              <div>End date
                                {{end_date}}
                              </div>
                            </form>
                          </div>
                      </li>
                      <li class="accordion-item" data-accordion-item>
                        <a href="#" class="accordion-title accordion-title--100">Variable</a>
                        <div class="accordion-content" data-tab-content>
                          <form>
                            {{variable}}
                            {{height}}
                          </form>
                        </div>
                      </li>
                    </ul>
                  </div>

                  <!-- Third panel content -->
                  <div class="tabs-panel" id="panel-feedinlib">
                    <p>
                      Select a variable and a time span, then click on a region highlighted on the map. The data will be displayed on a graph inside a popup.
                       Currently the plot in the popup window 
                      shows data received from a test data set.
                    </p>
                    <!--<div id="feedin-plot" style="width:300px;height:250px;">
                    </div>-->
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

        <button class="close-button" aria-label="Close menu" type="button" data-close>
          <span aria-hidden="true">&times;</span>
        </button>

      </div>
      <!-- OFF CANVAS END -->

      <!-- CONTENT (MAP + FOOTER) START -->
      <main class="off-canvas-content" data-off-canvas-content>
        <div class="map-wrapper">

          <button type="button" class="button open-offcanvas" data-toggle="offCanvas" title="Parameter">
            <i class="icon ion-android-options"></i>
          </button>

          {% leaflet_map "map" callback="window.map_init_basic" settings_overrides=leaflet_config%}

        </div>
      </main>
      <!-- CONTENT (MAP + FOOTER) END -->

    </div>

    <footer class="map-footer">
      <div class="grid-x">

        <div class="cell medium-4 large-6">
          <ul class="map-footer__legal">
            <li>
              <a class="anchor-text--dark" href="impressum">Impressum</a>
            </li>
            <li>
              <a class="anchor-text--dark" href="privacy">Datenschutz</a>
            </li>
          </ul>
        </div>

        <div class="cell medium-8 large-6">
          <ul class="map-footer__logo">
            <li>
              <a href="https://www.ovgu.de/" target="_blank" title="Otto von Guericke Universität Magdeburg">
                <img class="map-footer__logo-rli" src="{% static 'WAM_APP_FRED/img/ovgu.svg' %}" alt="Logo OVGU">
              </a>
            </li>
            <li>
              <a href="https://reiner-lemoine-institut.de/" target="_blank" title="Reiner Lemoine Institut">
                <img class="map-footer__logo-rli" src="{% static 'WAM_APP_FRED/img/rli.svg' %}" alt="Logo Reiner Lemoine Institut">
              </a>
            </li>
            <li>
              <a href="https://reiner-lemoine-institut.de/open_fred-open-feed-time-series-based-renewable-energy-database/" target="_blank" title="open_FRED">
                <img class="map-footer__logo-rli" src="{% static 'WAM_APP_FRED/img/open_fred.svg' %}" alt="Logo open_FRED">
              </a>
            </li>
            <li>
              <a href="https://www.bmwi.de/Navigation/DE/Home/home.html" target="_blank" title="Bundesminitserium für Wirtschaft und Energie">
                <img class="map-footer__logo-rli" src="{% static 'WAM_APP_FRED/img/bmwi.svg' %}" alt="Logo BMWI">
              </a>
            </li>
          </ul>
        </div>

      </div>
    </footer>

  </div>

  <script src="{% static 'WAM_APP_FRED/foundation/js/app.js' %}"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script type="text/javascript">

  
    function get_active_panel() {
      var active_panel = $('#fred-tabs').find('.tabs-panel.is-active').not('*[id*=options-]');
      active_panel = active_panel.attr('id');
      return active_panel;
    }


    document.getElementById("offcanvas-tabs").addEventListener(
      "click",
      function(event) {
        console.log(event.target);
        console.log(get_active_panel());
      });

    var biomassIcon = L.icon({
      iconUrl: "{% static 'WAM_APP_FRED/img/Pin_biomass_color_v2.svg' %}",
      iconSize: [38, 95], // size of the icon
      iconAnchor: [19, 72], // point of the icon which will correspond to marker's location
      popupAnchor: [0, -20] // point from which the popup should open relative to the iconAnchor
    });

    var solarRoofIcon = L.icon({
      iconUrl: "{% static 'WAM_APP_FRED/img/Pin_solarenergy_roof_color_v2.svg' %}",
      iconSize: [36, 44], // size of the icon
      iconAnchor: [18, 38], // point of the icon which will correspond to marker's location
      popupAnchor: [0, -20] // point from which the popup should open relative to the iconAnchor
    });

    var solarGroundIcon = L.icon({
      iconUrl: "{% static 'WAM_APP_FRED/img/Pin_solarenergy_ground_color_v2.svg' %}",
      iconSize: [36, 44], // size of the icon
      iconAnchor: [18, 44], // point of the icon which will correspond to marker's location
      popupAnchor: [0, -20] // point from which the popup should open relative to the iconAnchor
    });

    var windOffIcon = L.icon({
      iconUrl: "{% static 'WAM_APP_FRED/img/Pin_windenergy_offshore_color_v2.svg' %}",
      iconSize: [36, 44], // size of the icon
      iconAnchor: [18, 44], // point of the icon which will correspond to marker's location
      popupAnchor: [0, -20] // point from which the popup should open relative to the iconAnchor
    });

    var windOnIcon = L.icon({
      iconUrl: "{% static 'WAM_APP_FRED/img/Pin_windenergy_onshore_color_v2.svg' %}",
      iconSize: [36, 44], // size of the icon
      iconAnchor: [18, 44], // point of the icon which will correspond to marker's location
      popupAnchor: [0, -20] // point from which the popup should open relative to the iconAnchor
    });
    var hydroIcon = L.icon({
      iconUrl: "{% static 'WAM_APP_FRED/img/Pin_hydropower_color_v2.svg' %}",
      iconSize: [36, 44], // size of the icon
      iconAnchor: [18, 44], // point of the icon which will correspond to marker's location
      popupAnchor: [0, -20] // point from which the popup should open relative to the iconAnchor
    });

    var powerPlantIcon = L.icon({
      iconUrl: "{% static 'WAM_APP_FRED/img/powerplant.svg' %}",
      iconSize: [36, 44], // size of the icon
      iconAnchor: [18, 44], // point of the icon which will correspond to marker's location
      popupAnchor: [0, -20] // point from which the popup should open relative to the iconAnchor
    });

    var highlightStyle = {
      opacity: 0.7,
      weight: 2,
      fillOpacity: 0.7,
      color: "#0000ff",
      fillColor: "#0ba0ff",
    };
    var highlightStyleMouseOver = {
      opacity: 0.7,
      weight: 2,
      fillOpacity: 0.7,
      color: "#0000ff",
      fillColor: "#305EE2",
    };
    var clickedStyle = {
      opacity: 0.7,
      weight: 2,
      fillOpacity: 0.7,
      color: "#00ff00",
      fillColor: "#00ffff",
    };

    // define a var which holds a GEOJSON from a URL provided by django

    var mouse_click_location = "{% url 'WAM_APP_FRED:MouseClick'|add:'.data' %}";
    var weather_data_click_location = "{% url 'WAM_APP_FRED:WeatherPointClick'|add:'.data' %}";

    var ger_boundaries = "{% url 'WAM_APP_FRED:GerBoundary'|add:'.data' %}";

    var ppr_location = "{% url 'WAM_APP_FRED:PowerPlantRegister'|add:'.data' %}";
    var ppr_content = "{% url 'WAM_APP_FRED:PowerPlantPopup'|add:'.data' %}";

    var feedin_location = "{% url 'WAM_APP_FRED:FeedinlibLocation'|add:'.data' %}";
    var feedin_content = "{% url 'WAM_APP_FRED:FeedinlibPopup'|add:'.data' %}";


    function map_init_basic(map, options) {
      var popup = L.popup();

      let wdataStyle = {
        opacity: 0.7,
        weight: 1,
        fillOpacity: 0.7,
        color: "#da9700",
        fillColor: "#da9700",
        radius: 5
      };

      function createWDataPoint(feature, latlng) {
        return L.circleMarker(latlng, wdataStyle)
      };

      function displayWeatherDataPoint(feature) {
        var marker = wdl.getLayer(feature.properties.leaflet_id);

        var popup = marker.getPopup();
        const user_height = $('#id_wd-height').val();
        const variable = feature.properties.variable
        var popupContent = '<h4> Variable_id :' + variable +
          ' Height ' + user_height + ' m' +
          '</h4></br><div id="tester" style="width:300px;height:250px;"></div>';
        popup.setContent(popupContent)


        marker.feature.properties = feature.properties
        TESTER = document.getElementById('tester');
        var height = feature.properties.heights[0];
        Plotly.plot(TESTER, [{
          x: feature.properties.data[user_height]['x'],
          y: feature.properties.data[user_height]['y']
        }], {
          margin: {
            t: 0
          }
        });
      }

      function onWeatherDataPointClick(event) {

        var marker = event.sourceTarget;
        var leaflet_id = L.stamp(marker);
        var popup = marker.getPopup();
        var latlng = marker.getLatLng();
        var location_id = marker.feature.properties.id;
        // this need to be linked to user choice

        const start_year = $('#id_wd_timespan_start-year').val();
        const start_month = $('#id_wd_timespan_stop-month').val();
        const stop_year = $('#id_wd_timespan_stop-year').val();
        const stop_month = $('#id_wd_timespan_stop-month').val();

        const variable_id = $('select[id=id_wd-variable] option:selected').val();
        if (marker.feature.properties.variable) {
          // do not fetch the data a second time
          console.log('not fetching data a second time')
          displayWeatherDataPoint(marker.feature)
        } else {
          // here make a call to django and dl the data for that point
          $.ajax({
            type: 'POST',
            url: weather_data_click_location,
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            },
            data: {
              'lat': latlng.lat,
              'lon': latlng.lng,
              'leaflet_id': leaflet_id,
              'location_id': location_id,
              'variable_id': variable_id,
              'start_month': start_month,
              'start_year': start_year,
              'end_month': stop_month,
              'end_year': stop_year
            },
            success: displayWeatherDataPoint,
          });
        }
      }

      let wdataOptions = {
        pointToLayer: createWDataPoint,
        onEachFeature: function(feature, layer) {
          layer.on('mouseover', function() {
            this.setStyle(highlightStyleMouseOver);
          });
          layer.on('click', function() {
            this.setStyle(highlightStyle);
          });
          layer.on('mouseout', function() {
            this.setStyle(wdataStyle);
          });
          layer.bindPopup('Loading...');

          layer.on('click', onWeatherDataPointClick);
        }
      };


      var wdl = new L.geoJSON(null, wdataOptions);

      var wdl_saved = new L.geoJSON(null, wdataOptions);


      wdl.addTo(map);
      wdl_saved.addTo(map);


      // Move zoom control
      map.removeControl(map.zoomControl);
      L.control.zoom({
        position: 'topright'
      }).addTo(map);

      //L.marker([53.4554, 9.6211]).addTo(map); // example marker to quickly show if map loads

      // CIRCLE MARKER --> maybe outsource this section //////////////////////////////////////
      // create an object with a list of options to style the circle marker
      // see http://leafletjs.com/reference-1.3.0.html#path for additional options
      let myLayerStyle = {
        color: 'Orange',
        radius: 5,
        icon: powerPlantIcon
      };



      // add all of the GeoJSON data to the empty layer we created
      function createCircles(feature, latlng) {
        return L.marker(latlng, myLayerStyle)
      }



      // create an options object that specifies which function will called on each feature
      let myLayerOptions = {
        pointToLayer: createCircles
      };
      ///////////////////////////////////////////////////////////////////////////////////////

      // return current location of the mouse-courser
      // access the original DOM even translate to L.LatLag instance
      // Rest-full return the value to the server with POST with jQuery
      map.on('click', onMapClick);


      function addWeatherPoint(data) {
        // Clear the GeoJSON layer
        wdl.clearLayers()
        // Add GeoJSON data in the layer
        wdl.addData(data)
      }

      function onMapClick(ev) {
        var active_panel = get_active_panel();
        if (active_panel == 'panel-energy-system') {
          var latlng = map.mouseEventToLatLng(ev.originalEvent);
          $.ajax({
            type: 'POST',
            url: mouse_click_location,
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            },
            data: {
              'lat': latlng.lat,
              'lon': latlng.lng
            },
            success: addWeatherPoint,
          });
        }
      };


      // This is style setting for german boundary
      //should be outsourced -> style.css
      var GerBoundStyle = {
        opacity: 0.7,
        weight: 1,
        fillOpacity: 0.4,
        color: "#000000",
        fillColor: "#999999",
      };

      var GerBoundZoomLvlStyle = {
        opacity: 0.9,
        weight: 5,
        fillOpacity: 0.0,
        color: "#ffffff",
        fillColor: "#0BC11C",
      };

      // Germany region boundaries
      $.ajax({
        url: ger_boundaries,
        dataType: 'json',
        async: true,
        success: function(boundary) {
          function onEachFeature(boundary, layer) {
            layer.on('mouseover', function() {
              if (this.clicked != true) {
                this.setStyle(highlightStyleMouseOver);
              }
            });
            layer.on('mouseout', function() {
              if (this.clicked != true) {
                this.setStyle(GerBoundStyle);
              }
            });
            // select region and request data
            layer.on('click', function(event) {
              var active_panel = get_active_panel();
              this.clicked = true;
              this.setStyle(GerBoundZoomLvlStyle);
              region = event.sourceTarget;
              if (active_panel == 'panel-feedinlib') {
                loadRegionFeedin(region, layer);
              }

              if (active_panel == 'panel-powerplants') {
                loadRegionPowerPlants(region, layer);
              }

            });
          }
          var layer = new L.geoJSON(boundary, {
            onEachFeature: onEachFeature,
            style: function(feature, latlng) {
              return GerBoundStyle;
            }
          })
          map.addLayer(layer)
        }
      });

      //PowePlantRegister StartSection
      ///////////////////////////////////////////////////////////////////////////////////////////////////////
      // res PowerPlants in region boundaries

      function enablePowPlPopup(feature, layer) {
        layer.bindPopup('Loading...');
        layer.on('click', onPowerPlantDataPointClick);
      }

      var regionPowerPlantgroup = L.layerGroup().addTo(map);

      function createPowerPlantsPoints(powerplants) {
        var layer = new L.geoJSON(powerplants, {
          onEachFeature: enablePowPlPopup,
          pointToLayer: createCircles // addPowerPlantMarker
        });
        var clusters = L.markerClusterGroup();
        clusters.addLayer(layer);
        if (regionPowerPlantgroup.getLayers().length === 0) {
          regionPowerPlantgroup.addLayer(clusters)
        } else {
          regionPowerPlantgroup.clearLayers();
          regionPowerPlantgroup.addLayer(clusters)
        }
      }




      // request all power plants contained in selected region
      // also include the generation_type option
      function loadRegionPowerPlants(region, layer) {
        region_name = region.feature.properties.name;
        generation_type = $("input[name=generation_type]:checked").val();

        $.ajax({
          url: ppr_location,
          type: 'POST',
          async: true,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          },
          data: {
            'region_name': region_name,
            'generation_type': generation_type
          },
          success: createPowerPlantsPoints
        });
      }

      function onPowerPlantDataPointClick(event) {
        var marker = event.sourceTarget;
        var leaflet_id = L.stamp(marker);
        var pp_id = marker.feature.id;
        $.ajax({
          type: 'POST',
          url: ppr_content,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          },
          data: {
            'leaflet_id': leaflet_id,
            'pp_id': pp_id
          },
          success: function(thispopupcontent) {
            displayPowerPlantDataPoint(thispopupcontent, marker)
          }
        });
      }

      function displayPowerPlantDataPoint(feature, marker) {
        if (feature.property) {
          var keys = Object.keys(feature.property);
          var content = '<table class="selection_detail">';

          for (let i = 0, len = keys.length; i < len; i++) {
            content = content + '<tr><td align="right"><b>' + keys[i] + '</b>:</td><td>' + feature.property[keys[i]] + '</td></tr>'
          }
          content = content + '</table>';

          var popup = marker.getPopup();
          popup.setContent(content);

          // is this working????
          //addPowerPlantMarker(feature, marker);

        }
      }

      // add icon on to clicked circelmarker
      function addPowerPlantMarker(feature, latlng) {
        // ugly function body insert generic or something similar
        var marker = L.marker(latlng, myLayerStyle)

        console.log(feature);
        console.log(feature.property);
        console.log(feature.property.generation_subtype);

        if (feature.property.generation_subtype === "solar_roof_mounted") {
          marker.setIcon({
            icon: solarRoofIcon
          });
        }
        if (feature.properties.generation_subtype == "solar_ground_mounted") {
          marker.setIcon({
            icon: solarGroundIcon
          });
        }
        if (feature.property.generation_subtype == "solar") {
          marker.setIcon({
            icon: solarGroundIcon
          });
        }
        if (feature.properties.generation_subtype == "biomass") {
          marker.setIcon({
            icon: biomassIcon
          });
        }
        if (feature.properties.generation_subtype == "biogas") {
          marker.setIcon({
            icon: biomassIcon
          });
        }
        if (feature.properties.generation_subtype == "biogas_dry_fermentation") {
          marker.setIcon({
            icon: biomassIcon
          });
        }
        if (feature.properties.generation_subtype == "biofuel") {
          marker.setIcon({
            icon: biomassIcon
          });
        }
        if (feature.properties.generation_subtype == "wind_offshore") {
          marker.setIcon({
            icon: windOffIcon
          });
        }
        if (feature.properties.generation_subtype === "wind_onshore") {
          marker.setIcon({
            icon: windOnIcon
          });
        }
        if (feature.properties.generation_subtype == "hydro") {
          marker.setIcon({
            icon: hydroIcon
          });
        }
        if (feature.properties.generation_subtype == "geothermal") {
          // insert icon not availabe -> add when available
        }
        if (feature.properties.generation_subtype == "gas") {
          // insert icon not availabe -> add when available
        }
        if (feature.properties.generation_subtype == "biogas_from_grid") {
          // insert icon not availabe -> add when available
        }
        if (feature.properties.generation_subtype == "gas_mine") {
          // insert icon not availabe -> add when available
        }
        if (feature.properties.generation_subtype == "gas_sewage") {
          // insert icon not availabe -> add when available
        }
        if (feature.properties.generation_subtype == "gas_landfill") {
          // insert icon not availabe -> add when available
        }
        if (feature.properties.generation_subtype == "wood") {
          // insert icon not availabe -> add when available
        }
        if (feature.properties.generation_subtype == "waste_wood") {
          // insert icon not availabe -> add when available
        }
        return marker
      }

      //PowePlantRegister EndSection
      ///////////////////////////////////////////////////////////////////////////////////////////////////////

      ///// Feedinlib
      //
      function updateFeedinPopup(data, marker) {

        var popup = marker.getPopup();
        var popupContent = '<h4> Timeseries </h4></br><div id="feedin-plot" style="width:300px;height:250px;"></div>';
        popup.setContent(popupContent)

        plot_div = document.getElementById('feedin-plot');
        Plotly.plot(plot_div, [{
          x: data.timespan,
          y: data.values
        }], {
          margin: {
            t: 0
          }
        });
      };



      function onFeedinPointClick(event) {

        var marker = event.sourceTarget;
        var leaflet_id = L.stamp(marker);
        var popup = marker.getPopup();
        var latlng = marker.getLatLng();
        var region_id = marker.feature.id;
        // this need to be linked to user choice

        if (marker.feature.properties.timespan) {
          // do not fetch the data a second time
          console.log('not fetching data a second time')
          updateFeedinPopup(marker.feature, marker)
        } else {
          // here make a call to django and dl the data for that point
          $.ajax({
            type: 'POST',
            url: feedin_content,
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            },
            data: {
              'region_id': region_id,
            },
            success: function (data){
              updateFeedinPopup(data, marker)
            }
          });
        }
      }


      let feedinOptions = {
        pointToLayer: createFeedinPopup,
        onEachFeature: function(feature, layer) {

          layer.bindPopup('Loading...');

          layer.on('click', onFeedinPointClick);
        }
      };


      var fdl = new L.geoJSON(null, feedinOptions);

      fdl.addTo(map);

      function addFeedinPoint(feature){
        // Clear the GeoJSON layer
        fdl.clearLayers()
        // Add GeoJSON data in the layer
        fdl.addData(feature)
      }


      function createFeedinPopup(feature, latlng) {
        return L.circleMarker(latlng, wdataStyle)
      }


      function loadRegionFeedin(region, layer) {
        region_name = region.feature.properties.name;
        $.ajax({
          url: feedin_location,
          type: 'POST',
          async: true,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          },
          data: {
            'region_name': region_name,
          },
          success: addFeedinPoint
        });
      };




    };
  </script>

</body>

</html>
