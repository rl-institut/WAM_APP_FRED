<!DOCTYPE html>
{% load leaflet_tags %}
{% load static %}


<html class="no-js" lang="en">
  <head>


    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>open_FRED</title>
    <link rel="shortcut icon" type="image/png" href="{% static '/WAM_APP_FRED/img/fav/favicon.ico' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'stemp_abw/img/ionicons-2.0.1/css/ionicons.css' %}">
    <link rel="stylesheet" href="{% static 'WAM_APP_FRED/foundation/css/app.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
    {% leaflet_js %}
    {% leaflet_css %}
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  </head>
  <body>

    <div class="l-bg-color-w u-vh--100">

        <!-- TOP NAVIGATION START -->
        <!-- MAIN NAVIGATION START -->

        <nav>
          <div class="title-bar" id="nav-container" data-responsive-toggle="simple-menu" data-hide-for="medium">
            <button class="menu-icon" type="button" data-toggle></button>
            <div class="title-bar-title"></div>
          </div>

          <div class="top-bar" id="simple-menu">
            <div class="top-bar-left show-for-large">
              <ul class="menu">

              </ul>
            </div>
            <div class="top-bar-right">
              <ul class="dropdown menu" id="nav-list-vertical" data-dropdown-menu>
                <li>
                  <a class="anchor-text--light" href="#">Menu</a>
                  <ul class="menu vertical">

                    <li><a class="anchor-text--light" href="#">Kontakt</a></li>
                    <li><a class="anchor-text--light" href="#">Impressum</a></li>
                    <li><a class="anchor-text--light" href="#">Datenschutz</a></li>
                    <li><a class="anchor-text--light" href="#">Quellen</a></li>
                  </ul>
                </li>
              </ul>
            </div>
          </div>
        </nav>

        <!-- MAIN NAVIGATION END -->    <!-- TOP NAVIGATION END -->

        <div class="off-canvas-wrapper off-canvas-wrapper--left">

          <!-- OFF CANVAS START -->
          <div class="off-canvas position-left" id="offCanvas" data-off-canvas data-close-on-click="false" data-content-overlay="false" data-transition="overlap" style="color: black; overflow-y: hidden">

            <div class="grid-y medium-grid-frame">
              <div class="cell medium-auto medium-cell-block-container">
                <div class="grid-x">
                  <div class="cell small-3 offcanvas-tabs__wrapper medium-cell-block-y">
                    <ul class="vertical tabs" data-tabs id="offcanvas-tabs">
                      <li class="tabs-title is-active">
                        <a href="#panel-energy-system">
                          <img src="{% static 'WAM_APP_FRED/img/tab_icons/weather.svg' %}">
                          <h2 class="tabs-title__head">Weather Data</h2>
                        </a>
                      </li>
                      <li class="tabs-title">
                        <a href="#panel-scenario">
                          <img src="{% static 'WAM_APP_FRED/img/tab_icons/powerplants.svg' %}">
                          <h2 class="tabs-title__head">Power Plant Register</h2>
                        </a>
                      </li>
                      <li class="tabs-title">
                        <a href="#panel4v">
                          <img src="{% static 'WAM_APP_FRED/img/tab_icons/feedin.svg' %}">
                          <h2 class="tabs-title__head">Feedin-Time Series</h2>
                        </a>
                      </li>
                    </ul>
            
                  </div>
                  <div class="cell small-9 medium-cell-block-y tabs-content__wrapper">
                      <div class="tabs-content" data-tabs-content="offcanvas-tabs">
    
                        <!-- First panel content -->
                        <div class="tabs-panel" id="panel-scenario">
                          <form>
                            <fieldset>
                              <legend>Szenario auswählen 
                                <i class ="icon ion-information-circled icon--small" title="Informationen zum Inhalt"></i>
                              </legend>
                              <div>
                                <input type="radio" name="scenario" value="statusQuo" id="scenarioStatusQuo" required checked>
                                <label for="scenarioStatusQuo">Status Quo</label>
                              </div>
                              <div>
                                <input type="radio" name="scenario" value="germany" id="scenarioGermany">
                                <label for="scenarioGermany">Deutsches Klimaschutzziel</label>
                              </div>
                              <div>
                                <input type="radio" name="scenario" value="100" id="scenario100">
                                <label for="scenario100">100% EE in der Region</label>
                              </div>
                            </fieldset>
                          </form>

                          <div class="panel__text panel__text--highlighted">
                            <p id="scenarioPanelText">
                                <span style="font-weight:700">Status Quo</span><span style="display:inline-block"></span>
                            </p>
                          </div>
                        </div>
          
                        <!-- Second panel content -->
                        <div class="tabs-panel is-active" id="panel-energy-system">



                          <ul class="accordion" data-accordion>
                            <li class="accordion-item accordion-item--no-border is-active" data-accordion-item>
                              <a href="#" class="accordion-title accordion-title--100">Time Span</a>
                              <div class="accordion-content" data-tab-content >
                                <div class="tabs-panel is-active" id="panel-energy-system">
                                  <form id="TimeSpan">

                                    <label for="Start">Start</label>
                                    <input id="Start">
                                    <label for="Stop">Stop</label>
                                    <input id="Stop">
                                  </form>
                              </div>
                            </li>
                            <li class="accordion-item" data-accordion-item>
                              <a href="#" class="accordion-title accordion-title--100">Variable</a>
                              <div class="accordion-content" data-tab-content>
                                <form id="Variable">

                                  <label>Variable</label>
                                  <select name="variable">
                                    <option>1</option>
                                    <option>2</option>
                                    <option>3</option>
                                    <option>4</option>
                                  </select>
                                </form>
                              </div>
                            </li>
                            <li class="accordion-item" data-accordion-item>
                              <a href="#" class="accordion-title accordion-title--100">Flag</a>
                              <div class="accordion-content" data-tab-content>
                                Some Input:
                                <input type="text">
                              </div>
                            </li>
                          </ul>
                        </div>
          
                        <!-- Third panel content -->
                        <div class="tabs-panel" id="panel3v">

                        </div>
          
                        <!-- Fourth panel content -->
                        <div class="tabs-panel" id="panel4v">
                          <p>This will show some graphs soon</p>
                          <img class="thumbnail" src="{% static 'stemp_abw/img/generic/rectangle-2.jpg' %}">
                        </div>
                      </div>
    
                  </div>
                </div>
              </div>
            </div>
    
            <button class="close-button" aria-label="Close menu" type="button" data-close>
              <span aria-hidden="true">&times;</span>
            </button>
    
          </div>
          <!-- OFF CANVAS END -->
      
          <!-- CONTENT (MAP + FOOTER) START -->
          <main class="off-canvas-content" data-off-canvas-content>
            <div class="map-wrapper">
              
              <button type="button" class="button open-offcanvas" data-toggle="offCanvas" title="Parameter">
                <i class="icon ion-android-options"></i>
              </button>

              {% leaflet_map "map" callback="window.map_init_basic" settings_overrides=leaflet_config%}
      
            </div>
          </main>
          <!-- CONTENT (MAP + FOOTER) END -->
      
        </div>
      
        <footer class="map-footer">
          <div class="grid-x">
    
            <div class="cell medium-4 large-6">
              <ul class="map-footer__legal">
                <li>
                  <a class="anchor-text--dark" href="#">Impressum</a>
                </li>
                <li>
                  <a class="anchor-text--dark" href="#">Datenschutz</a>
                </li>
              </ul>
            </div>
    
            <div class="cell medium-8 large-6">
              <ul class="map-footer__logo">
                <li>
                  <a href="https://www.ovgu.de/" target="_blank" title="Otto von Guericke Universität Magdeburg">
                    <img class="map-footer__logo-rli" src="{% static 'WAM_APP_FRED/img/ovgu.svg' %}" alt="Logo OVGU">
                  </a>
                </li>
                <li>
                  <a href="https://reiner-lemoine-institut.de/" target="_blank" title="Reiner Lemoine Institut">
                    <img class="map-footer__logo-rli" src="{% static 'WAM_APP_FRED/img/rli.svg' %}" alt="Logo Reiner Lemoine Institut">
                  </a>
                </li>
                <li>
                  <a href="https://reiner-lemoine-institut.de/open_fred-open-feed-time-series-based-renewable-energy-database/" target="_blank" title="open_FRED">
                    <img class="map-footer__logo-rli" src="{% static 'WAM_APP_FRED/img/open_fred.svg' %}" alt="Logo open_FRED">
                  </a>
                </li>
                <li>
                  <a href="https://www.bmwi.de/Navigation/DE/Home/home.html" target="_blank" title="Bundesminitserium für Wirtschaft und Energie">
                    <img class="map-footer__logo-rli" src="{% static 'WAM_APP_FRED/img/bmwi.svg' %}" alt="Logo BMWI">
                  </a>
                </li>
              </ul>
            </div>
    
          </div>
        </footer>
      
      </div>

    <script src="{% static 'WAM_APP_FRED/foundation/js/app.js' %}"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript">

            var biomassIcon = L.icon({
                iconUrl: "{% static 'WAM_APP_FRED/img/Pin_biomass_color_v2.svg' %}",
                iconSize:     [38, 95], // size of the icon
                iconAnchor:   [19, 72], // point of the icon which will correspond to marker's location
                popupAnchor:  [0, -20] // point from which the popup should open relative to the iconAnchor
            });
            
            var solarRoofIcon = L.icon({
                iconUrl: "{% static 'WAM_APP_FRED/img/Pin_solarenergy_roof_color_v2.svg' %}",
                iconSize:     [36, 44], // size of the icon
                iconAnchor:   [18, 38], // point of the icon which will correspond to marker's location
                popupAnchor:  [0, -20] // point from which the popup should open relative to the iconAnchor
            });

            var solarGroundIcon = L.icon({
                iconUrl: "{% static 'WAM_APP_FRED/img/Pin_solarenergy_ground_color_v2.svg' %}",
                iconSize:     [36, 44], // size of the icon
                iconAnchor:   [18, 44], // point of the icon which will correspond to marker's location
                popupAnchor:  [0, -20] // point from which the popup should open relative to the iconAnchor
            });

            var windOffIcon = L.icon({
                iconUrl: "{% static 'WAM_APP_FRED/img/Pin_windenergy_offshore_color_v2.svg' %}",
                iconSize:     [36, 44], // size of the icon
                iconAnchor:   [18, 44], // point of the icon which will correspond to marker's location
                popupAnchor:  [0, -20] // point from which the popup should open relative to the iconAnchor
            });

            var windOnIcon = L.icon({
                iconUrl: "{% static 'WAM_APP_FRED/img/Pin_windenergy_onshore_color_v2.svg' %}",
                iconSize:     [36, 44], // size of the icon
                iconAnchor:   [18, 44], // point of the icon which will correspond to marker's location
                popupAnchor:  [0, -20] // point from which the popup should open relative to the iconAnchor
            });
      
            var highlightStyle = {
                  opacity: 0.7,
                  weight: 2,
                  fillOpacity: 0.7,
                  color: "#0000ff",
                  fillColor: "#0ba0ff",
              };
              var clickedStyle = {
                  opacity: 0.7,
                  weight: 2,
                  fillOpacity: 0.7,
                  color: "#00ff00",
                  fillColor: "#00ffff",
              };

            // define a var which holds a GEOJSON from a URL provided by django
            var locations_dataurl = "{% url 'WAM_APP_FRED:Locations'|add:'.data' %}";
            var mouse_click_location = "{% url 'WAM_APP_FRED:MouseClick'|add:'.data' %}";
            var weather_data_click_location = "{% url 'WAM_APP_FRED:WeatherPointClick'|add:'.data' %}";


            function map_init_basic (map, options) {
              var popup = L.popup();

              let wdataStyle = {
                    opacity: 0.7,
                    weight: 1,
                    fillOpacity: 0.7,
                    color: "#da9700",
                    fillColor: "#da9700",
                radius: 5
              };
              function createWDataPoint (feature, latlng) {
                return L.circleMarker(latlng, wdataStyle)
              };

              function displayWeatherDataPoint(feature){
                  var marker = wdl.getLayer(feature.properties.leaflet_id);
                  var popup = marker.getPopup();
                  const variable = feature.properties.variable
                  var popupContent = '<h4>' + variable +
                  '</h4></br><div id="tester" style="width:300px;height:250px;"></div>';
                  popup.setContent(popupContent)
                  marker.feature.properties = feature.properties
                  TESTER = document.getElementById('tester');
                  var height = feature.properties.heights[0];
                  Plotly.plot( TESTER, [{
                  x: feature.properties.data[height]['x'],
                  y: feature.properties.data[height]['y']}], {
                  margin: { t: 0 } } );
                  }

              function onWeatherDataPointClick (event) {

                  var marker = event.sourceTarget;
                  var leaflet_id = L.stamp(marker);
                  var popup = marker.getPopup();
                  var latlng = marker.getLatLng();
                  var location_id = marker.feature.properties.id;
                  // this need to be linked to user choice
                  var variable_id = 12;

                  var start_time = '2002-01-31T23:00:00';
                  var end_time = '2002-03-31T23:00:00';

                  // do not fetch the data a second time
                  if (marker.feature.properties.variable){
                  console.log('not fetching data a second time')
                  displayWeatherDataPoint(marker.feature)
                  }
                  else{
                  // here make a call to django and dl the data for that point
                  $.ajax({
                      type: 'POST',
                      url: weather_data_click_location,
                      headers: {'X-CSRFToken': '{{ csrf_token }}'},
                      data: {
                      'lat': latlng.lat,
                      'lon': latlng.lng,
                      'leaflet_id': leaflet_id,
                      'location_id': location_id,
                      'variable_id': variable_id,
                      'start_time': start_time,
                      'end_time': end_time
                      },
                      success: displayWeatherDataPoint,
                  });
                  }
              }

              let wdataOptions = {
                pointToLayer: createWDataPoint,
                onEachFeature: function(feature, layer) {
                layer.on('mouseover', function () {
                  this.setStyle(highlightStyle);
                });
                layer.on('click', function () {
                  this.setStyle(highlightStyle);
                });
                layer.on('mouseout', function () {
                  this.setStyle(wdataStyle);
                });
                  layer.bindPopup('Loading...');

                  layer.on('click', onWeatherDataPointClick);
                  }
              };

              var wdl = new L.geoJSON(null, wdataOptions);

              var wdl_saved = new L.geoJSON(null, wdataOptions);


              wdl.addTo(map);
              wdl_saved.addTo(map);


              // Move zoom control
              map.removeControl(map.zoomControl);
              L.control.zoom({
                position: 'topright'
              }).addTo(map);

              //L.marker([53.4554, 9.6211]).addTo(map); // example marker to quickly show if map loads

              // CIRCLE MARKER --> maybe outsource this section //////////////////////////////////////
              // create an object with a list of options to style the circle marker
              // see http://leafletjs.com/reference-1.3.0.html#path for additional options
              let myLayerStyle = {
                color: 'Orange',
                radius: 5
              };



              // add all of the GeoJSON data to the empty layer we created
              function createCircles (feature, latlng) {
                return L.circleMarker(latlng, myLayerStyle)
              }



              // create an options object that specifies which function will called on each feature
              let myLayerOptions = {
                pointToLayer: createCircles
              };
              ///////////////////////////////////////////////////////////////////////////////////////


              // create a ajax call for locations_dataurl
              $.ajax({
                    url: locations_dataurl,
                    dataType: 'json',
                    async: true,
                    // if the data-source can be accessed, create a GEOJSON layer
                    success: function(loca){
                      // create the GeoJSON layer from the myLayerData object
                      L.geoJSON(loca).addTo(map)

                    }
              });

              // return current location of the mouse-courser
              // access the original DOM even translate to L.LatLag instance
              // Rest-full return the value to the server with POST with jQuery
              map.on('click', onMapClick);

            function addWeatherPoint(data) {
                // Clear the GeoJSON layer
                wdl.clearLayers()
                // Add GeoJSON data in the layer
                wdl.addData(data)
            }

	          function onMapClick(ev) {
                  var latlng = map.mouseEventToLatLng(ev.originalEvent);
                  $.ajax({
                      type: 'POST',
                      url: mouse_click_location,
                      headers: {'X-CSRFToken': '{{ csrf_token }}'},
                      data: {'lat': latlng.lat, 'lon': latlng.lng},
                      success: addWeatherPoint,
                  });
	          };
            };

    </script>

  </body>
</html>
